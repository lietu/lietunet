<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Nginx reverse proxy cache for multiple sites - Janne "Lietu" Enberg</title><meta name=twitter:card content="summary_large_image"><meta name=twitter:creator content="@lietux"><meta name=twitter:title content><meta name=twitter:description content><meta name=Description content><meta property="og:title" content="Nginx reverse proxy cache for multiple sites"><meta property="og:description" content="IntroductionIf you are hosting a site or multiple sites where performance is more important than that updates are immediately visible, or that the architecture is especially &#34;cool&#34;, you might want to think of running Nginx as a reverse proxying cache server.
What this approach provides is easily configurable lightning fast serving of your content.
What you will needNginx installed on a server (I'm sure you can find another guide for this)Write access to Nginx configuration directoryMain web server listening on non-default port (e."><meta property="og:type" content="article"><meta property="og:url" content="https://lietu.net/2013/03/2013-03-21-nginx-reverse-proxy-cache-for-multiple-sites/"><meta property="article:section" content="post"><meta property="article:published_time" content="2013-03-21T00:00:00+00:00"><meta property="article:modified_time" content="2013-03-21T00:00:00+00:00"><meta name=application-name content="Janne &#34;Lietu&#34; Enberg"><meta name=apple-mobile-web-app-title content="Janne &#34;Lietu&#34; Enberg"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=icon type=image/png sizes=192x192 href=/android-chrome-192x192.png><link rel=icon type=image/png sizes=512x512 href=/android-chrome-512x512.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://lietu.net/2013/03/2013-03-21-nginx-reverse-proxy-cache-for-multiple-sites/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/lib/prismjs/prism.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Nginx reverse proxy cache for multiple sites","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/lietu.net\/2013\/03\/2013-03-21-nginx-reverse-proxy-cache-for-multiple-sites\/"},"genre":"post","wordCount":1215,"url":"https:\/\/lietu.net\/2013\/03\/2013-03-21-nginx-reverse-proxy-cache-for-multiple-sites\/","datePublished":"2013-03-21T00:00:00+00:00","dateModified":"2013-03-21T00:00:00+00:00","description":""}</script></head><body data-header-desktop data-header-mobile><script>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'dark'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'dark'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header><div class="desktop header" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title='Janne "Lietu" Enberg' class="header-logo logo-svg">Janne "Lietu" Enberg</a></div><div class=menu><nav><h2 class=display-hidden>Основная навигация</h2><ul class=menu-inner><li><a class=menu-item href=/post/>Posts</a></li></ul></nav><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><span class="svg-icon icon-moon"></span></a></div></div></div><div class="mobile header" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title='Janne "Lietu" Enberg' class=header-logo>Janne "Lietu" Enberg</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><nav><h2 class=display-hidden>Основная навигация</h2><ul><li><a class=menu-item href=/post/ title>Posts</a></li></ul></nav><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><span class="svg-icon icon-moon"></span></a></div></div></div></header><main class=main><div class=container><div class="page single special"><h1 class="single-title pulse faster">Nginx reverse proxy cache for multiple sites</h1><div class=content id=content><h4>Introduction</h4><p>If you are hosting a site or multiple sites where performance is more important than that updates are immediately visible, or that the architecture is especially "cool", you might want to think of running Nginx as a reverse proxying cache server.</p><p>What this approach provides is easily configurable lightning fast serving of your content.</p><h4>What you will need</h4><p><ul><li>Nginx installed on a server (I'm sure you can find another guide for this)</li><li>Write access to Nginx configuration directory</li><li>Main web server listening on non-default port (e.g. 8080), or on a different server.</li></ul></p><h4>Directory structure</h4><p>First, locate your nginx configuration folder, it's often /etc/nginx, but you can try: find / -name "nginx.conf"</p><p>Inside the configuration folder we will be creating the following structure:</p><p><ul><li>sites-available - Different site configurations</li><li>sites-enabled - Currently enabled sites' configurations</li><li>include.d - Shared configuration files for sites</li><li>conf.d - Additional configuration files</li></ul></p><p>To do this go in your nginx configuration folder, e.g. /etc/nginx and run the following:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir sites-available sites-enabled include.d conf.d</code></pre></div><p>It is safe to ignore errors such as "mkdir: cannot create directory `sites-available': File exists".</p><h4>Base configuration</h4><p>First step is to configure Nginx to some decent defaults.</p><p>Open up your nginx.conf from your nginx configuration folder</p><p>Replace the file contents with the following, reading the comments and adjusting accordingly:</p><div class=highlight><pre class=chroma><code class=language-nginx data-lang=nginx><span class=c1># The user to run Nginx as, often www, www-data or nginx
</span><span class=c1># It is safest to leave the previous setting as it is
</span><span class=c1></span><span class=k>user</span> <span class=s>www-data</span><span class=p>;</span>

<span class=c1># Decent starting point for this is the number of cores/threads on the machine
</span><span class=c1># cat /proc/cpuinfo | grep ^processor | wc -l
</span><span class=c1></span><span class=k>worker_processes</span> <span class=mi>4</span><span class=p>;</span>

<span class=c1># Pid file location, the default value will often be just fine
</span><span class=c1></span><span class=k>pid</span> <span class=s>/var/run/nginx.pid</span><span class=p>;</span>


<span class=k>events</span> <span class=p>{</span>
	<span class=c1># 1024 is a decent starting point
</span><span class=c1></span>	<span class=c1># You can increase it further, but you should check &#34;ulimit -n&#34; before
</span><span class=c1></span>	<span class=c1># adjusting higher
</span><span class=c1></span>	<span class=kn>worker_connections</span> <span class=mi>1024</span><span class=p>;</span>

	<span class=c1># If you find that this gives you extra performance feel free to uncomment
</span><span class=c1></span>	<span class=c1># I however didn&#39;t find it to have any effect at all
</span><span class=c1></span>	<span class=c1># multi_accept on;
</span><span class=c1></span><span class=p>}</span>

<span class=k>http</span> <span class=p>{</span>

	<span class=c1>#
</span><span class=c1></span>	<span class=c1># Basic optimizations
</span><span class=c1></span>	<span class=c1>#
</span><span class=c1></span>
	<span class=kn>sendfile</span> <span class=no>on</span><span class=p>;</span>
	<span class=kn>tcp_nodelay</span> <span class=no>on</span><span class=p>;</span>

	<span class=c1># This might be better set to on for some, off for some
</span><span class=c1></span>	<span class=c1># for me however, I saw no difference between having it enabled or disabled
</span><span class=c1></span>	<span class=kn>tcp_nopush</span> <span class=no>on</span><span class=p>;</span>

	<span class=c1># How long to wait for new request from the same connection
</span><span class=c1></span>	<span class=kn>keepalive_timeout</span> <span class=mi>180</span><span class=p>;</span>

	<span class=c1># Don&#39;t advertise every detail of the server to all requests (security)
</span><span class=c1></span>	<span class=kn>server_tokens</span> <span class=no>off</span><span class=p>;</span>

	<span class=c1># Uncomment if you for some reason have a very long domain name
</span><span class=c1></span>	<span class=c1># server_names_hash_bucket_size 64;
</span><span class=c1></span>
	<span class=c1># File type detection and default
</span><span class=c1></span>	<span class=kn>include</span> <span class=s>/etc/nginx/mime.types</span><span class=p>;</span>
	<span class=kn>default_type</span> <span class=s>application/octet-stream</span><span class=p>;</span>


	<span class=c1>#
</span><span class=c1></span>	<span class=c1># Logging Settings
</span><span class=c1></span>	<span class=c1>#
</span><span class=c1></span>
	<span class=c1># Access logging is a bit of useless, don&#39;t 
</span><span class=c1></span>	<span class=c1># enable it unless you really need to
</span><span class=c1></span>	<span class=c1># access_log /var/log/nginx/access.log;
</span><span class=c1></span>
	<span class=c1># Error logging however is useful, make sure the destination folder exists
</span><span class=c1></span>	<span class=kn>error_log</span> <span class=s>/var/log/nginx/error.log</span><span class=p>;</span>


	<span class=c1>#
</span><span class=c1></span>	<span class=c1># Gzip Settings
</span><span class=c1></span>	<span class=c1>#
</span><span class=c1></span>	<span class=c1># Gzipping content will increase performance from client&#39;s point of view
</span><span class=c1></span>	<span class=c1>#
</span><span class=c1></span>
	<span class=c1># Enable Gzip compression
</span><span class=c1></span>	<span class=kn>gzip</span> <span class=no>on</span><span class=p>;</span>

	<span class=c1># But disable it for clients that don&#39;t support it
</span><span class=c1></span>	<span class=kn>gzip_disable</span> <span class=s>&#34;msie6&#34;</span><span class=p>;</span>
	<span class=kn>gzip_disable</span> <span class=s>&#34;Wget&#34;</span><span class=p>;</span>

	<span class=c1># Make sure any third-party proxies cache things properly
</span><span class=c1></span>	<span class=kn>gzip_vary</span> <span class=no>on</span><span class=p>;</span>

	<span class=c1># Compress regardless of caching headers
</span><span class=c1></span>	<span class=kn>gzip_proxied</span> <span class=s>any</span><span class=p>;</span>

	<span class=c1># Compress as much as possible
</span><span class=c1></span>	<span class=kn>gzip_comp_level</span> <span class=mi>9</span><span class=p>;</span>

	<span class=c1># You might want to change this to 1.0 if you find Gzip gives you more
</span><span class=c1></span>	<span class=c1># than keepalive, as keepalive won&#39;t work with 1.0 and Gzip
</span><span class=c1></span>	<span class=c1># gzip_http_version 1.0;
</span><span class=c1></span>
	<span class=c1># File types to Gzip compress, it works best for plain text files
</span><span class=c1></span>	<span class=kn>gzip_types</span> <span class=s>text/plain</span> <span class=s>text/css</span> <span class=s>application/json</span> <span class=s>application/x-javascript</span> <span class=s>text/xml</span> <span class=s>application/xml</span> <span class=s>application/xml+rss</span> <span class=s>text/javascript</span><span class=p>;</span>


	<span class=c1>#
</span><span class=c1></span>	<span class=c1># Caching
</span><span class=c1></span>	<span class=c1>#
</span><span class=c1></span>
	<span class=c1># Enables proxy cache to /var/cache/nginx/xx/xx/xx/*
</span><span class=c1></span>	<span class=c1># ... calls the cache &#34;STATIC&#34;
</span><span class=c1></span>	<span class=c1># ... delete files from cache completely if not requested within 24h
</span><span class=c1></span>	<span class=c1># ... and allow a maximum of 1GB of disk space to be consumed for it
</span><span class=c1></span>	<span class=c1>#
</span><span class=c1></span>	<span class=c1># Make sure the directory /var/cache/nginx exists and
</span><span class=c1></span>	<span class=c1># is writable by the Nginx user, or change the path
</span><span class=c1></span>	<span class=c1>#
</span><span class=c1></span>	<span class=kn>proxy_cache_path</span> <span class=s>/var/cache/nginx</span> <span class=s>levels=2:2:2</span> <span class=s>keys_zone=STATIC:1000m</span> <span class=s>inactive=24h</span> <span class=s>max_size=1g</span><span class=p>;</span>

	<span class=c1># Include all additional configuration files (please do check their contents)
</span><span class=c1></span>	<span class=kn>include</span> <span class=s>/etc/nginx/conf.d/*.conf</span><span class=p>;</span>

	<span class=c1># Include all configs for enabled sites
</span><span class=c1></span>	<span class=kn>include</span> <span class=s>/etc/nginx/sites-enabled/*</span><span class=p>;</span>
<span class=p>}</span></code></pre></div><h4>Common site configuration</h4><p>This is configuration that will be shared by all your sites.</p><p>Create the file include.d/proxy.conf inside your nginx configuration directory and insert the contents below.</p><div class=highlight><pre class=chroma><code class=language-nginx data-lang=nginx><span class=c1># Defines if reverse-proxying should use HTTP 1.0 or 1.1
</span><span class=c1># You should try which gives you better results, 
</span><span class=c1># or if you find any significant differences at all
</span><span class=c1></span><span class=k>proxy_http_version</span>		<span class=mi>1</span><span class=s>.0</span><span class=p>;</span>

<span class=c1># Pass through the original Host the request was made for
</span><span class=c1></span><span class=k>proxy_set_header</span>		<span class=s>Host</span> <span class=nv>$host</span><span class=p>;</span>

<span class=c1># Allow destination server to know where the proxied requests came from
</span><span class=c1></span><span class=k>proxy_set_header</span>		<span class=s>X-Real-IP</span> <span class=nv>$remote_addr</span><span class=p>;</span>
<span class=k>proxy_set_header</span>		<span class=s>X-Forwarded-For</span> <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>

<span class=c1># Clear a few headers we might not want to pass on
</span><span class=c1># If you do not know what these do, it&#39;s safe to leave them as is
</span><span class=c1># If you do, you should know if you want to clear them or not
</span><span class=c1></span><span class=k>proxy_set_header</span>		<span class=s>Accept</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
<span class=k>proxy_set_header</span>		<span class=s>Connection</span> <span class=s>&#34;&#34;</span><span class=p>;</span>

<span class=c1># Enable caching for the proxied requests using the STATIC storage
</span><span class=c1></span><span class=k>proxy_cache</span>				<span class=s>STATIC</span><span class=p>;</span>

<span class=c1># Cache 200 (OK), as well as 301 and 302 (redirect) responses for 4h
</span><span class=c1></span><span class=k>proxy_cache_valid</span>		<span class=mi>200</span> <span class=mi>301</span> <span class=mi>302</span> <span class=s>4h</span><span class=p>;</span>

<span class=c1># Cache 404 (Not found) responses for only 10m, just in case of human errors
</span><span class=c1></span><span class=k>proxy_cache_valid</span>		<span class=mi>404</span> <span class=mi>10m</span><span class=p>;</span>

<span class=c1># Allow using stale data (cached data that has expired) in the following cases:
</span><span class=c1># - an error has occurred while connecting to the server, sending a request to it, or reading its response
</span><span class=c1># - timeout occurred during the connection with the server, transfer the request or while reading response from the server
</span><span class=c1># - server returned a empty or incorrect answer
</span><span class=c1># - server returned an error status (500, 502-504)
</span><span class=c1></span><span class=k>proxy_cache_use_stale</span>	<span class=s>error</span> <span class=s>timeout</span> <span class=s>invalid_header</span> <span class=s>updating</span> <span class=s>http_500</span> <span class=s>http_502</span> <span class=s>http_503</span> <span class=s>http_504</span><span class=p>;</span>

<span class=c1>#
</span><span class=c1># Please be sure to understand that this configuration doesn&#39;t care much about
</span><span class=c1># what kind of headers the server sends about if the content should be cached
</span><span class=c1># or not, it just does it&#39;s thing.
</span><span class=c1>#
</span><span class=c1># For more information, see: http://wiki.nginx.org/HttpProxyModule#proxy_no_cache
</span><span class=c1></span><span class=err>#</span></code></pre></div><h4>Site configuration</h4><p>Now for the site-specific configuration. I will be writing the configuration for http://example.com/, but you should of course adjust for your own domain.</p><p>Place this in sites-available/example.com in the nginx configuration folder.</p><div class=highlight><pre class=chroma><code class=language-nginx data-lang=nginx><span class=c1># Reverse proxy http://example.com/ to 127.0.0.1:8080
</span><span class=c1></span><span class=k>server</span> <span class=p>{</span>
	<span class=kn>listen</span> <span class=mi>80</span><span class=p>;</span>

	<span class=c1># The domain name(s) to respond to
</span><span class=c1></span>	<span class=kn>server_name</span> <span class=s>example.com</span><span class=p>;</span>

	<span class=c1># All requests should be handled like this:
</span><span class=c1></span>	<span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
		<span class=c1># Reverse proxy to 127.0.0.1:8080
</span><span class=c1></span>		<span class=c1># (change accordingly to your configuration)
</span><span class=c1></span>		<span class=kn>proxy_pass</span> <span class=s>http://127.0.0.1:8080</span><span class=p>;</span>

		<span class=c1># Append common proxy configuration
</span><span class=c1></span>		<span class=kn>include</span> <span class=s>include.d/proxy.conf</span><span class=p>;</span>
	<span class=p>}</span>

<span class=p>}</span>

<span class=c1># Permanently redirect *://*.example.com/* to *://example.com/*
</span><span class=c1>#
</span><span class=c1># It might be that you don&#39;t want this, but I see
</span><span class=c1># it as vital search engine optimization
</span><span class=c1></span><span class=k>server</span> <span class=p>{</span>
	<span class=kn>listen</span> <span class=mi>80</span><span class=p>;</span>
	<span class=kn>server_name</span> <span class=s>*.example.com</span><span class=p>;</span>
	<span class=kn>return</span> <span class=mi>301</span> <span class=nv>$scheme://example.com$request_uri</span><span class=p>;</span>
<span class=p>}</span></code></pre></div><p>You can create as many of these as you need to.</p><h4>Enabling/disabling sites</h4><p>Now to enable a site, you just symlink a file from sites-available/domain.com to sites-enabled/domain.com and reload nginx config. To disable one, you remove the sites-enabled symlink and reload the config.</p><p>Assuming your nginx configuration folder is at /etc/nginx, you can run the following to enable domain.com:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>ln -s /etc/nginx/sites-available/domain.com /etc/nginx/sites-enabled</code></pre></div><h4>More reading</h4><p>Here's a few links to interesting resources on Nginx configuration:</p><p><ul><li><a href=http://wiki.nginx.org/Pitfalls>http://wiki.nginx.org/Pitfalls</a></li><li><a href=http://wiki.nginx.org/QuickStart>http://wiki.nginx.org/QuickStart</a></li><li><a href=http://wiki.nginx.org/Configuration>http://wiki.nginx.org/Configuration</a></li></ul></p><h4>Further thoughts</h4><p>Combine this with my <a href=/2013/02/simple-website-cache-warmup-tool.html>performance test / cache warmup tool</a> and you should have a snappy site.</p></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.83.1">Hugo</a> | Theme - <a href="https://ublogger.netlify.app/?utm_source=https://lietu.net/&utm_medium=footer&utm_campaign=config&utm_term=2.0.1" target=_blank title="uBlogger 2.0.1">uBlogger</a></div><div class=footer-line><i class="svg-icon icon-copyright"></i><span>2021</span></div></div></footer></div><aside id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="svg-icon icon-arrow-up"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="svg-icon icon-comments-fixed"></i></a></aside><script src=/lib/smooth-scroll/smooth-scroll.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{}}</script><script src=/js/theme.min.js></script></body></html>